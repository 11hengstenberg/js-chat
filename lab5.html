<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <head>
    </head>
    <body>
        <script type="application/javascript">

            //constantes que se utilizaran

            //para recibir mensajes 
            const mensaje = document.createElement('ul')
            //contiene a todos los elementos dentro.
            const contenedor = document.createElement('div')
            //boton para mandar mensajes
            const button = document.createElement('button')
            //espacio para escribir y mandar el mensaje.
            const label = document.createElement('textarea')
            

            //Boton para agregar imagenes
            const archivo = document.createElement('button')

            //Constante para la url 
            const url = 'http://msdeus.site:7000'
            //texto del boton
            button.append("Send")

            //140 limite de caracteres
            label.maxLength = 140
            document.body.append(mensaje)
            document.body.append(contenedor) 

            contenedor.appendChild(button)
            contenedor.appendChild(label)
            contenedor.appendChild(mensaje)

            contenedor.style = `
                display: absolute;
                position: absolute;

                border-radius: 40px 40px 40px 40px;
                -moz-border-radius: 40px 40px 40px 40px;
                -webkit-border-radius: 40px 40px 40px 40px;
                border: 0px solid #000000;

                background: #1800FE;
                width: 80%;
                height: 55%;
                left: 100px;
                right: 100px;
            `
            label.style = `
                width: 76%;
                height: 10%;
                top: 360px; 

                border-radius: 20px 20px 20px 20px;
                -moz-border-radius: 20px 20px 20px 20px;
                -webkit-border-radius: 20px 20px 20px 20px;


                background: #A9AAFE;


                position: absolute;
                left: 15px;
            ` 
            button.style = `
                width: 20%;
                height: 10%;
                position: absolute;
                top: 362px;
                right: 10px;
                
                border-radius: 40px 40px 40px 40px;
                -moz-border-radius: 40px 40px 40px 40px;
                -webkit-border-radius: 40px 40px 40px 40px;


                background: #A9AAFE;

            `
            mensaje.style = `
                width: 95%;
                height: 82%;
                position: absolute;

                border-radius: 40px 40px 40px 40px;
                -moz-border-radius: 40px 40px 40px 40px;
                -webkit-border-radius: 40px 40px 40px 40px;
                background: #9596FD;

                left: 5px;
                top: -12px;
                overflow-y: scroll;
                border: 2px solid blue;
            `
        //Funcion para obtener mensajes
        function obtenerMensaje(){
            mensaje.innerHTML = "";
            fetch(url, {method: "GET"})
                .then(response => {return response.json()})
                //Buscamos por cada lista (for)
                .then(response => {response.forEach(element => {
                    //Si encuentra una imagen (jpg or jpeg or png)
                    if ((/\.(jpg|jpeg|png)$/i).test(element.chatmessage)) {
                        const message_imagen = document.createElement("div")
                        //Para meter la imagen encontrada
                        const cuadrado = document.createElement('div')
                        const strong = document.createElement("strong")
                        const image = document.createElement("img")
                        //Cuadrado para diferenciar el usuario
                        cuadrado.style = `
                            max-width: 100px;
                            max-height: 100px;
                            border-radius: 84px 84px 0px 84px;
                            -moz-border-radius: 84px 84px 0px 84px;
                            -webkit-border-radius: 84px 84px 0px 84px;
                            border: 0px solid #000000;
                            background: #E4E5FF;
                        ` 
                        //AÃ±adimos los elementos
                        strong.append(element.username + ": ")
                        cuadrado.append(strong)
                        message_imagen.append(cuadrado)
                        //Le damos un valor maximo a la imagen para que no se salga del width
                        image.src = element.chatmessage
                        image.style = `
                            max-width: 250px;
                            max-height: 250px;
                        `
                        message_imagen.append(image)
                        mensaje.append(message_imagen)
                        mensaje.scrollTop = mensaje.scrollHeight

                    //Encuentra un mensaje sin obtener ningun parametro
                    } else {
                        //Encontrar un mensaje
                        const message = document.createElement("div")
                        //Limite para el maximo de caracteres por linea
                        message.maxLength = 50
                        const strong = document.createElement("strong")
                        message.style = `
                            max-width: 300px;
                            background: red;
                        `
                        strong.append(element.username + ": ")
                        strong.append("")
                        //Agregamos cada uno de los elementos encontrados al elemento de html
                        message.append(strong)
                        message.append(element.chatmessage)
                        mensaje.appendChild(message)
                        mensaje.scrollTop = mensaje.scrollHeight
                        strong.append("")
                        strong.append("")
                        strong.append("")

                    }
                })
            })
        }
        //Mandar un mensaje
        button.onclick = function(){
            fetch(url, {method: "POST",
                body: `
                    {
                        "username": "Anonimo",
                        "chatmessage": "${label.value.trim()}"
                    }
                `
            }).then(() =>{
                label.innerHTML = ""
                obtenerMensaje()
            }).then(() =>{
                label.value = ""
            })
        }

        //Utilizar el teclado para manda un mensaje
       label.addEventListener('keypress', function(){
           if(event.key == 'Enter'){
               fetch(url, {method: 'POST',
                    body: `
                        {
                            "username": "asdfasdf",
                            "chatmessage": "${label.value.trim()}"
                        }  
                    `
               }).then(() =>{
                   label.innerHTML = ""
                   obtenerMensaje()
               }).then(() =>{
                   label.value = ""
               })
               event.preventDefault()
           }
       })
       setTimeout(obtenerMensaje(), 1)
        </script>
    </body>
</html>
